<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Cuenta - Tienda Online</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
</head>

<body>
    <nav class="main-nav">
        <div class="nav-center">
            <a href="/" id="inicio-link">ğŸ  Inicio</a>
            <a href="productos.html" id="productos-link" style="display:none;">ğŸ“¦ Productos</a>
            <a href="pedidos.html" id="pedidos-link" style="display:none;">ğŸ“‹ Mis pedidos</a>
            <a href="admin.html" id="admin-link" style="display:none;">âš™ï¸ Admin</a>
            <a href="login.html" id="login-link">ğŸ” Iniciar sesiÃ³n</a>
            <a href="register.html" id="register-link" class="active">ğŸ“ Registrarse</a>
            <a href="documentacion.html" id="docs-link">ğŸ“š DocumentaciÃ³n</a>
        </div>
        <div id="user-menu" class="user-menu" style="display:none;">
            <button id="user-menu-btn" class="user-menu-btn">
                <span id="user-info"></span>
                <span style="margin-left:0.4em;">â–¼</span>
            </button>
            <div id="user-menu-dropdown" class="user-menu-dropdown" style="display:none;">
                <button onclick="logout()">Cerrar sesiÃ³n</button>
            </div>
        </div>
    </nav>
    <div class="welcome-container">
        <!-- SECCIÃ“N: CREAR CUENTA (fuera del cuadro principal) -->
        <div class="register-standalone-form">
            <div class="section-header">
                <h2>ğŸ“ Crear Cuenta</h2>
                <p class="section-description">Ãšnete a nuestra tienda online y comienza a comprar</p>
            </div>
            <div class="auth-card" style="box-shadow:none;background:none;padding-top:0;max-width:500px;width:100%;">
                <form id="register-form" class="auth-form">
                    <div class="form-group">
                        <label for="username">Usuario</label>
                        <div class="input-with-icon">
                            <span class="input-icon">ğŸ‘¤</span>
                            <input type="text" id="username" placeholder="Elige un nombre de usuario" required
                                autocomplete="username">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="email">Correo electrÃ³nico</label>
                        <div class="input-with-icon">
                            <span class="input-icon">ğŸ“§</span>
                            <input type="email" id="email" placeholder="Tu correo electrÃ³nico" required
                                autocomplete="email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="password">ContraseÃ±a</label>
                        <div class="input-with-icon">
                            <span class="input-icon">ğŸ”’</span>
                            <input type="password" id="password" placeholder="Crea una contraseÃ±a" required
                                autocomplete="new-password">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full-width">ğŸš€ Crear Cuenta</button>
                </form>
                <div id="register-error" class="error-message" style="display:none"></div>
                <div id="register-success" class="success-message" style="display:none"></div>
                <div class="auth-footer" style="margin-top:0.3em;">
                    <p>Â¿Ya tienes una cuenta? <a href="login.html" class="link">ğŸ” Inicia sesiÃ³n aquÃ­</a></p>
                </div>
            </div>
        </div>

        <!-- SEPARADOR VISUAL -->
        <div class="section-divider" style="margin:1em 0 1.5em 0;"></div>

        <!-- SECCIÃ“N: INFORMACIÃ“N POST-REGISTRO -->
        <section class="welcome-section register-info-section section-box" style="margin-top:1em;">
            <div class="section-header">
                <h2>â„¹ï¸ InformaciÃ³n Importante</h2>
                <p class="section-description">Todo lo que necesitas saber sobre tu nueva cuenta</p>
            </div>
            <div class="users-grid-responsive">
                <div class="feature-card-simple success-card" style="align-items:center;">
                    <div class="feature-icon" style="text-align:center;width:100%;">âœ…</div>
                    <h3 style="text-align:center;width:100%;">DespuÃ©s del Registro</h3>
                    <ul style="text-align:left;width:100%;margin-left:0;">
                        <li>SerÃ¡s redirigido automÃ¡ticamente al inicio</li>
                        <li>Puedes usar el formulario de login para acceder</li>
                        <li>Tu cuenta tendrÃ¡ permisos de cliente por defecto</li>
                        <li>PodrÃ¡s ver productos, aÃ±adir al carrito y hacer pedidos</li>
                    </ul>
                </div>
                <div class="feature-card-simple warning-card">
                    <div class="feature-icon">ğŸ”’</div>
                    <h3>Cuenta de Administrador</h3>
                    <p>Para obtener permisos de administrador, contacta con el administrador del sistema o usa las
                        credenciales de prueba en la pÃ¡gina de login.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- PIE DE PÃGINA -->
    <footer class="modern-footer">
        <div class="footer-bottom">
            <p>&copy; 2025 Tienda Online - Desarrollado con Spring Boot</p>
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.getElementById('register-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Mostrar indicador de carga
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'ğŸ”„ Creando cuenta...';
            submitBtn.disabled = true;

            // Ocultar mensajes previos
            document.getElementById('register-error').style.display = 'none';
            document.getElementById('register-success').style.display = 'none';

            try {
                const username = document.getElementById('username').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                const res = await fetch('/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                if (res.ok) {
                    // Ã‰xito
                    document.getElementById('register-success').textContent = 'âœ… Â¡Registro exitoso! Redirigiendo al inicio...';
                    document.getElementById('register-success').style.display = 'block';

                    submitBtn.textContent = 'âœ… Â¡Cuenta creada!';
                    submitBtn.style.background = '#28a745';

                    setTimeout(() => window.location.href = '/', 2000);

                } else {
                    // Error
                    let msg = 'No se pudo registrar. Â¿Usuario o email ya existen?';
                    try {
                        const err = await res.json();
                        if (err && err.message) msg = err.message;
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }

                    document.getElementById('register-error').textContent = 'âŒ ' + msg;
                    document.getElementById('register-error').style.display = 'block';

                    // Restaurar botÃ³n
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    submitBtn.style.background = '';
                }

            } catch (error) {
                console.error('Error durante el registro:', error);

                document.getElementById('register-error').textContent = 'âŒ Error de conexiÃ³n. Por favor, intenta nuevamente.';
                document.getElementById('register-error').style.display = 'block';

                // Restaurar botÃ³n
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                submitBtn.style.background = '';
            }
        });

        // Verificar si ya estÃ¡ logueado
        document.addEventListener('DOMContentLoaded', () => {
            const jwt = localStorage.getItem('jwt');
            const role = localStorage.getItem('role');

            if (jwt && role) {
                // Ya estÃ¡ logueado, redirigir segÃºn el rol
                if (role === 'ADMIN') {
                    window.location.href = 'admin.html';
                } else if (role === 'CLIENTE') {
                    window.location.href = 'productos.html';
                } else {
                    window.location.href = '/';
                }
            }
        });
    </script>
</body>

</html>
