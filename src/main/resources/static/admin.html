<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Tienda Online</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
</head>

<body>
    <nav class="main-nav">
        <div class="nav-center">
            <a href="admin.html" id="admin-link">⚙️ Admin</a>
            <a href="/" id="inicio-link">🏠 Inicio</a>
            <a href="pedidos.html" id="pedidos-link" style="display:none;">📋 Mis pedidos</a>
            <a href="login.html" id="login-link">🔐 Iniciar sesión</a>
            <a href="register.html" id="register-link">📝 Registrarse</a>
            <a href="documentacion.html" id="docs-link">📚 Documentación</a>
            <a href="productos.html" id="productos-link">📦 Productos</a>
        </div>
        <div id="user-menu" class="user-menu" style="display:none;">
            <button id="user-menu-btn" class="user-menu-btn">
                <span>👤</span>
                <span id="user-info"></span>
                <span style="margin-left:0.4em;">▼</span>
            </button>
            <div id="user-menu-dropdown" class="user-menu-dropdown" style="display:none;">
                <button onclick="logout()">Cerrar sesión</button>
            </div>
        </div>
    </nav>
    <div class="welcome-container">
        <header class="simple-header" style="text-align: center;">
            <h1>⚙️ Panel de Administración</h1>
            <p style="text-align: center;">Gestiona productos, pedidos y usuarios de la tienda online</p>
        </header>
        <div class="container">
            <!-- Dashboard -->
            <section id="dashboard-section" class="admin-section-simple section-box">
                <div class="db-info-panel info-box-simple" id="db-info-panel">
                    <h3>📊 Información de la Base de Datos</h3>
                    <ul id="db-info-list">
                        <!-- Aquí se cargará dinámicamente la información de la base de datos -->
                    </ul>
                </div>
            </section>

            <!-- Gestión de Pedidos -->
            <section id="pedidos-section" class="admin-section section-box" style="display:none;">
                <h2>📋 Gestión de Pedidos</h2>
                <div class="filter-bar">
                    <select id="estado-filter">
                        <option value="">Todos los estados</option>
                        <option value="PENDIENTE">Pendientes</option>
                        <option value="ENVIADO">Enviados</option>
                        <option value="ENTREGADO">Entregados</option>
                        <option value="CANCELADO">Cancelados</option>
                    </select>
                    <button onclick="loadPedidos()" class="btn btn-secondary">🔍 Filtrar</button>
                </div>
                <div id="admin-pedidos" class="pedidos-list">
                    <div class="loading">Cargando pedidos...</div>
                </div>
            </section>

            <!-- Vista de Usuarios -->
            <section id="usuarios-section" class="admin-section section-box" style="display:none;">
                <h2>👥 Usuarios Registrados</h2>
                <div class="section-actions">
                    <button class="btn btn-primary" onclick="adminDataManager.loadAllUsers()">🔄 Recargar
                        Usuarios</button>
                </div>
                <div id="users-list" class="usuarios-list">
                    <div class="loading">Cargando usuarios...</div>
                </div>
            </section>
        </div>
    </div>
    <footer class="modern-footer">
        <div class="footer-bottom">
            <p>&copy; 2025 Tienda Online - Desarrollado con Spring Boot</p>
        </div>
    </footer>
    <div id="notification" class="notification" style="display:none;"></div>
    <script src="js/app.js"></script>
    <script src="js/admin-data.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Animación de números en dashboard
        document.addEventListener('DOMContentLoaded', function () {
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(m => {
                    if (m.target.classList) {
                        m.target.classList.add('admin-animate-number');
                        setTimeout(() => m.target.classList.remove('admin-animate-number'), 800);
                    }
                });
            });
            document.querySelectorAll('.stat-number').forEach(el => {
                observer.observe(el, { childList: true });
            });
        });

        // Mostrar totales y más info en la info de la base de datos
        async function loadDashboard() {
            try {
                const jwt = localStorage.getItem('jwt');
                const headers = { 'Authorization': 'Bearer ' + jwt };

                // Cargar productos
                const productosRes = await fetch('/api/productos', { headers });
                let productos = [];
                if (productosRes.ok) {
                    productos = await productosRes.json();
                }

                // Cargar pedidos
                const pedidosRes = await fetch('/api/pedidos', { headers });
                let pedidos = [];
                if (pedidosRes.ok) {
                    pedidos = await pedidosRes.json();
                }

                // Cargar usuarios (simulado o implementa tu endpoint)
                let totalUsuarios = 2;
                let usuarios = [];
                try {
                    const usuariosRes = await fetch('/api/admin/users', { headers });
                    if (usuariosRes.ok) {
                        usuarios = await usuariosRes.json();
                        totalUsuarios = usuarios.length;
                    }
                } catch { }

                // Estadísticas adicionales
                const pedidosPendientes = pedidos.filter(p => p.estado === 'PENDIENTE').length;
                const pedidosEnviados = pedidos.filter(p => p.estado === 'ENVIADO').length;
                const pedidosEntregados = pedidos.filter(p => p.estado === 'ENTREGADO').length;
                const pedidosCancelados = pedidos.filter(p => p.estado === 'CANCELADO').length;
                const productosSinStock = productos.filter(p => (p.stock || 0) === 0).length;
                const totalStock = productos.reduce((sum, p) => sum + (p.stock || 0), 0);
                const productosUnicosPedidos = new Set(pedidos.flatMap(p => p.productos.map(i => i.productoId))).size;
                const ultimoPedido = pedidos.length > 0 ? new Date(Math.max(...pedidos.map(p => new Date(p.fecha)))).toLocaleString('es-ES') : 'N/A';
                const primerPedido = pedidos.length > 0 ? new Date(Math.min(...pedidos.map(p => new Date(p.fecha)))).toLocaleString('es-ES') : 'N/A';

                // Mostrar en la lista
                const dbInfoList = document.getElementById('db-info-list');
                dbInfoList.innerHTML = `
                    <li><strong>Total Productos:</strong> <span class="stat-number">${productos.length}</span></li>
                    <li><strong>Total Pedidos:</strong> <span class="stat-number">${pedidos.length}</span></li>
                    <li><strong>Pedidos Pendientes:</strong> <span class="stat-number">${pedidosPendientes}</span></li>
                    <li><strong>Pedidos Enviados:</strong> <span class="stat-number">${pedidosEnviados}</span></li>
                    <li><strong>Pedidos Entregados:</strong> <span class="stat-number">${pedidosEntregados}</span></li>
                    <li><strong>Pedidos Cancelados:</strong> <span class="stat-number">${pedidosCancelados}</span></li>
                    <li><strong>Total Usuarios:</strong> <span class="stat-number">${totalUsuarios}</span></li>
                    <li><strong>Productos sin stock:</strong> <span class="stat-number">${productosSinStock}</span></li>
                    <li><strong>Stock total disponible:</strong> <span class="stat-number">${totalStock}</span></li>
                    <li><strong>Productos distintos en pedidos:</strong> <span class="stat-number">${productosUnicosPedidos}</span></li>
                    <li><strong>Fecha del primer pedido:</strong> <span>${primerPedido}</span></li>
                    <li><strong>Fecha del último pedido:</strong> <span>${ultimoPedido}</span></li>
                `;
            } catch (error) {
                showNotification('Error al cargar el dashboard', 'error');
            }
        }

        // Llama a loadDashboard al cargar la página
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>

</html>
