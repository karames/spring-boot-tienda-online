<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Autenticaci√≥n - Tienda Online</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <!-- Los estilos est√°n ahora en el archivo CSS principal -->
</head>

<body>
    <nav class="main-nav">
        <div class="nav-center">
            <a href="/" id="inicio-link">üè† Inicio</a>
            <a href="productos.html" id="productos-link" style="display:none;">üì¶ Productos</a>
            <a href="pedidos.html" id="pedidos-link" style="display:none;">üìã Mis pedidos</a>
            <a href="admin.html" id="admin-link" style="display:none;">‚öôÔ∏è Admin</a>
            <a href="documentacion.html" id="docs-link">üìö Documentaci√≥n</a>
            <a href="login.html" id="login-link">üîê Iniciar sesi√≥n</a>
            <a href="register.html" id="register-link">üìù Registrarse</a>
        </div>
        <div id="user-menu" class="user-menu" style="display:none;">
            <button id="user-menu-btn" class="user-menu-btn">
                <span id="user-info"></span>
                <span style="margin-left:0.4em;">‚ñº</span>
            </button>
            <div id="user-menu-dropdown" class="user-menu-dropdown" style="display:none;">
                <button onclick="logout()">Cerrar sesi√≥n</button>
            </div>
        </div>
    </nav>
    <div class="welcome-container">
        <header class="simple-header">
            <h1>üß™ Test de Autenticaci√≥n</h1>
            <p>Herramientas de testing para verificar el sistema de autenticaci√≥n</p>
        </header>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h3>üìä Estado Actual</h3>
            <button onclick="checkCurrentState()" class="btn-test">üîç Verificar Estado</button>
            <div id="current-state"></div>
        </div>

        <div class="test-section">
            <h3>üîê Test de Login</h3>
            <div class="form-group">
                <label for="test-username">Usuario:</label>
                <input type="text" id="test-username" value="admin" placeholder="Nombre de usuario">
            </div>
            <div class="form-group">
                <label for="test-password">Contrase√±a:</label>
                <input type="password" id="test-password" value="admin" placeholder="Contrase√±a">
            </div>
            <button onclick="testLogin()" class="btn-test">üîë Probar Login</button>
            <div id="login-result"></div>
        </div>

        <div class="test-section">
            <h3>üéØ Test de Redirecciones</h3>
            <button onclick="testAdminAccess()" class="btn-test">‚öôÔ∏è Probar Admin</button>
            <button onclick="testProductosAccess()" class="btn-test">üì¶ Probar Productos</button>
            <button onclick="testPedidosAccess()" class="btn-test">üìã Probar Pedidos</button>
            <div id="redirect-result"></div>
        </div>

        <div class="test-section">
            <h3>üßπ Limpieza</h3>
            <button onclick="clearAll()" class="btn-test">üóëÔ∏è Limpiar LocalStorage</button>
            <button onclick="testLogout()" class="btn-test">üö™ Test Logout</button>
            <div id="cleanup-result"></div>
        </div>

        <div class="test-section">
            <h3>üìã Log de Eventos</h3>
            <button onclick="clearLog()" class="btn-test">üßπ Limpiar Log</button>
            <div id="event-log" class="result-container"
                style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('event-log');
            const entry = document.createElement('div');
            entry.className = `test-result ${type}`;
            entry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[TEST] ${message}`);
        }

        function checkCurrentState() {
            const jwt = localStorage.getItem('jwt');
            const role = localStorage.getItem('role');
            const username = localStorage.getItem('username');
            const loginSuccess = localStorage.getItem('loginSuccess');
            const loginTimestamp = localStorage.getItem('loginTimestamp');

            const stateDiv = document.getElementById('current-state');
            stateDiv.innerHTML = `
                <div class="test-result info">
                    <strong>Estado del LocalStorage:</strong><br>
                    JWT: ${jwt ? '‚úÖ Presente (' + jwt.substring(0, 30) + '...)' : '‚ùå No presente'}<br>
                    Role: ${role ? '‚úÖ ' + role : '‚ùå No presente'}<br>
                    Username: ${username ? '‚úÖ ' + username : '‚ùå No presente'}<br>
                    Login Success: ${loginSuccess ? '‚úÖ ' + loginSuccess : '‚ùå No presente'}<br>
                    Login Timestamp: ${loginTimestamp ? '‚úÖ ' + new Date(parseInt(loginTimestamp)).toLocaleString() : '‚ùå No presente'}
                </div>
            `;

            log(`Estado verificado - JWT: ${!!jwt}, Role: ${role}, Username: ${username}`);
        }

        async function testLogin() {
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;
            const resultDiv = document.getElementById('login-result');

            try {
                log(`Intentando login con usuario: ${username}`);

                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    localStorage.setItem('jwt', data.token);
                    localStorage.setItem('role', data.role);
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('loginSuccess', 'true');
                    localStorage.setItem('loginTimestamp', Date.now().toString());

                    resultDiv.innerHTML = `
                        <div class="test-result success">
                            ‚úÖ Login exitoso<br>
                            Usuario: ${data.username}<br>
                            Rol: ${data.role}<br>
                            Token guardado en localStorage
                        </div>
                    `;

                    log(`Login exitoso - Usuario: ${data.username}, Rol: ${data.role}`, 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="test-result error">
                            ‚ùå Login fallido<br>
                            Error: ${data.mensaje || 'Error desconocido'}
                        </div>
                    `;

                    log(`Login fallido - ${data.mensaje || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        ‚ùå Error de conexi√≥n<br>
                        ${error.message}
                    </div>
                `;

                log(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        function testAdminAccess() {
            log('Probando acceso a p√°gina de admin...');
            window.location.href = 'admin.html';
        }

        function testProductosAccess() {
            log('Probando acceso a p√°gina de productos...');
            window.location.href = 'productos.html';
        }

        function testPedidosAccess() {
            log('Probando acceso a p√°gina de pedidos...');
            window.location.href = 'pedidos.html';
        }

        function clearAll() {
            localStorage.clear();
            const resultDiv = document.getElementById('cleanup-result');
            resultDiv.innerHTML = `
                <div class="test-result success">
                    ‚úÖ LocalStorage limpiado completamente
                </div>
            `;
            log('LocalStorage limpiado completamente', 'success');
        }

        function testLogout() {
            if (typeof logout === 'function') {
                logout();
                const resultDiv = document.getElementById('cleanup-result');
                resultDiv.innerHTML = `
                    <div class="test-result success">
                        ‚úÖ Funci√≥n logout ejecutada
                    </div>
                `;
                log('Funci√≥n logout ejecutada', 'success');
            } else {
                const resultDiv = document.getElementById('cleanup-result');
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        ‚ùå Funci√≥n logout no encontrada
                    </div>
                `;
                log('Funci√≥n logout no encontrada', 'error');
            }
        }

        function clearLog() {
            document.getElementById('event-log').innerHTML = '';
        }

        // Auto-verificar estado al cargar
        document.addEventListener('DOMContentLoaded', () => {
            log('Test de autenticaci√≥n iniciado');
            checkCurrentState();
        });
    </script>
</body>

</html>
